"use strict";(self.webpackChunkwaku_guide=self.webpackChunkwaku_guide||[]).push([[5306],{3905:(e,t,a)=>{a.d(t,{Zo:()=>m,kt:()=>d});var r=a(67294);function s(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function n(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?n(Object(a),!0).forEach((function(t){s(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):n(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,r,s=function(e,t){if(null==e)return{};var a,r,s={},n=Object.keys(e);for(r=0;r<n.length;r++)a=n[r],t.indexOf(a)>=0||(s[a]=e[a]);return s}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(r=0;r<n.length;r++)a=n[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(s[a]=e[a])}return s}var p=r.createContext({}),l=function(e){var t=r.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},m=function(e){var t=l(e.components);return r.createElement(p.Provider,{value:t},e.children)},u="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var a=e.components,s=e.mdxType,n=e.originalType,p=e.parentName,m=o(e,["components","mdxType","originalType","parentName"]),u=l(a),h=s,d=u["".concat(p,".").concat(h)]||u[h]||c[h]||n;return a?r.createElement(d,i(i({ref:t},m),{},{components:a})):r.createElement(d,i({ref:t},m))}));function d(e,t){var a=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var n=a.length,i=new Array(n);i[0]=h;var o={};for(var p in t)hasOwnProperty.call(t,p)&&(o[p]=t[p]);o.originalType=e,o[u]="string"==typeof e?e:s,i[1]=o;for(var l=2;l<n;l++)i[l]=a[l];return r.createElement.apply(null,i)}return r.createElement.apply(null,a)}h.displayName="MDXCreateElement"},96608:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>c,frontMatter:()=>n,metadata:()=>o,toc:()=>l});var r=a(87462),s=(a(67294),a(3905));const n={title:"PostgreSQL",description:"Document that describes why Nim-Waku started to use Postgres and shows some benchmark and comparison results."},i=void 0,o={unversionedId:"research/benchmarks/postgres-adoption",id:"research/benchmarks/postgres-adoption",title:"PostgreSQL",description:"Document that describes why Nim-Waku started to use Postgres and shows some benchmark and comparison results.",source:"@site/docs/research/benchmarks/postgres-adoption.md",sourceDirName:"research/benchmarks",slug:"/research/benchmarks/postgres-adoption",permalink:"/research/benchmarks/postgres-adoption",draft:!1,editUrl:"https://github.com/waku-org/docs.waku.org/tree/develop/docs/research/benchmarks/postgres-adoption.md",tags:[],version:"current",lastUpdatedAt:1729480127,formattedLastUpdatedAt:"21 Oct 2024",frontMatter:{title:"PostgreSQL",description:"Document that describes why Nim-Waku started to use Postgres and shows some benchmark and comparison results."},sidebar:"research",previous:{title:"Research",permalink:"/research/"},next:{title:"Capped Bandwidth in Waku",permalink:"/research/research-and-studies/capped-bandwidth"}},p={},l=[{value:"Introduction",id:"introduction",level:2},{value:"How to connect the <em>nwaku</em> to <em>Postgres</em>",id:"how-to-connect-the-nwaku-to-postgres",level:2},{value:"Examples of <em>nwaku</em> using <em>Postgres</em>",id:"examples-of-nwaku-using-postgres",level:2},{value:"Stress tests",id:"stress-tests",level:2},{value:"Insert test results",id:"insert-test-results",level:3},{value:"Maximum insert throughput",id:"maximum-insert-throughput",level:4},{value:"Query test results (jmeter)",id:"query-test-results-jmeter",level:3},{value:"Query test results (only Store protocol)",id:"query-test-results-only-store-protocol",level:3},{value:"Comparing archive SQLite &amp; Postgres performance in nwaku-b6dd6899",id:"comparing-archive-sqlite--postgres-performance-in-nwaku-b6dd6899",level:4},{value:"Comparing archive SQLite &amp; Postgres performance in nwaku-b452ed8",id:"comparing-archive-sqlite--postgres-performance-in-nwaku-b452ed8",level:4},{value:"Conclusions",id:"conclusions",level:4},{value:"Multiple nodes &amp; one single database",id:"multiple-nodes--one-single-database",level:3},{value:"Results",id:"results",level:4}],m={toc:l},u="wrapper";function c(e){let{components:t,...n}=e;return(0,s.kt)(u,(0,r.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h2",{id:"introduction"},"Introduction"),(0,s.kt)("p",null,"The ",(0,s.kt)("em",{parentName:"p"},"Nim Waku Node"),", ",(0,s.kt)("em",{parentName:"p"},"nwaku"),", has the capability of archiving messages until a certain limit (e.g. 30 days) so that other nodes can synchronize their message history throughout the ",(0,s.kt)("em",{parentName:"p"},"Store")," protocol."),(0,s.kt)("p",null,"The ",(0,s.kt)("em",{parentName:"p"},"nwaku")," originally used ",(0,s.kt)("em",{parentName:"p"},"SQLite")," to archive messages but this has an impact on the node. ",(0,s.kt)("em",{parentName:"p"},"Nwaku")," is single-threaded and therefore, any ",(0,s.kt)("em",{parentName:"p"},"SQLite")," operation impacts the performance of other protocols, like ",(0,s.kt)("em",{parentName:"p"},"Relay.")),(0,s.kt)("p",null,"Therefore, the ",(0,s.kt)("em",{parentName:"p"},"Postgres")," adoption is needed to enhance that."),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://github.com/waku-org/nwaku/issues/1888"},"https://github.com/waku-org/nwaku/issues/1888")),(0,s.kt)("h2",{id:"how-to-connect-the-nwaku-to-postgres"},"How to connect the ",(0,s.kt)("em",{parentName:"h2"},"nwaku")," to ",(0,s.kt)("em",{parentName:"h2"},"Postgres")),(0,s.kt)("p",null,"Simply pass the next parameter to ",(0,s.kt)("em",{parentName:"p"},"nwaku")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'--store-message-db-url="postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/postgres\n')),(0,s.kt)("p",null,"Notice that this only makes sense if the ",(0,s.kt)("em",{parentName:"p"},"nwaku")," has the ",(0,s.kt)("em",{parentName:"p"},"Store")," protocol mounted"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"--store=true\n")),(0,s.kt)("p",null,"(start the ",(0,s.kt)("em",{parentName:"p"},"nwaku")," node with ",(0,s.kt)("inlineCode",{parentName:"p"},"--help")," parameter for more ",(0,s.kt)("em",{parentName:"p"},"Store")," options)"),(0,s.kt)("h2",{id:"examples-of-nwaku-using-postgres"},"Examples of ",(0,s.kt)("em",{parentName:"h2"},"nwaku")," using ",(0,s.kt)("em",{parentName:"h2"},"Postgres")),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://github.com/waku-org/nwaku-compose"},"https://github.com/waku-org/nwaku-compose")),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://github.com/waku-org/test-waku-query"},"https://github.com/waku-org/test-waku-query")),(0,s.kt)("h2",{id:"stress-tests"},"Stress tests"),(0,s.kt)("p",null,"The following repository was created as a tool to stress and compare performance between ",(0,s.kt)("em",{parentName:"p"},"nwaku"),"+",(0,s.kt)("em",{parentName:"p"},"Postgres")," and ",(0,s.kt)("em",{parentName:"p"},"nwaku"),"+",(0,s.kt)("em",{parentName:"p"},"SQLite"),":"),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://github.com/waku-org/test-waku-query"},"https://github.com/waku-org/test-waku-query")),(0,s.kt)("h3",{id:"insert-test-results"},"Insert test results"),(0,s.kt)("h4",{id:"maximum-insert-throughput"},"Maximum insert throughput"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Scenario")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"1 node subscribed to pubsubtopic \u2018x\u2019 and the ",(0,s.kt)("em",{parentName:"li"},"Store")," protocol mounted."),(0,s.kt)("li",{parentName:"ul"},"\u2018n\u2019 nodes connected to the \u201cstore\u201d node, and publishing messages simultaneously to pubsubtopic \u2018x\u2019."),(0,s.kt)("li",{parentName:"ul"},"All nodes running locally in a ",(0,s.kt)("em",{parentName:"li"},"Dell Latitude 7640"),"."),(0,s.kt)("li",{parentName:"ul"},"Each published message is fixed, 1.4 KB: ",(0,s.kt)("a",{parentName:"li",href:"https://github.com/waku-org/test-waku-query/blob/master/sh/publish_one_client.sh"},"publish_one_client.sh")),(0,s.kt)("li",{parentName:"ul"},"The next script is used to simulate multiple nodes publishing messages: ",(0,s.kt)("a",{parentName:"li",href:"https://github.com/waku-org/test-waku-query/blob/fe7061a21eb14395e723402face755c826077aec/sh/publish_multiple_clients.sh"},"publish_multiple_clients.sh"))),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Sought goal")),(0,s.kt)("p",null,"Find out the maximum number of concurrent inserts that both ",(0,s.kt)("em",{parentName:"p"},"SQLite")," and ",(0,s.kt)("em",{parentName:"p"},"Postgres")," could support, and check whether ",(0,s.kt)("em",{parentName:"p"},"Postgres")," behaves better than ",(0,s.kt)("em",{parentName:"p"},"SQLite")," or not."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Conclusion")),(0,s.kt)("p",null,"Messages are lost after a certain threshold, and this message loss is due to limitations in the ",(0,s.kt)("em",{parentName:"p"},"Relay")," protocol (GossipSub - libp2p.)"),(0,s.kt)("p",null,"For example, if we set 30 nodes publishing 300 messages simultaneously, then 8997 rows were stored and not the expected 9000, in both ",(0,s.kt)("em",{parentName:"p"},"SQLite")," and ",(0,s.kt)("em",{parentName:"p"},"Postgres")," databases."),(0,s.kt)("p",null,"The reason why few messages were lost is because the message rate was higher than the ",(0,s.kt)("em",{parentName:"p"},"relay")," protocol can support, and therefore a few messages were not stored. In this example, the test took 38.8\u2019\u2019, and therefore, the node was receiving 232 msgs/sec, which is much more than the normal rate a node will work with, which is ~10 msgs/sec (rate extracted from Grafana\u2019s stats for the ",(0,s.kt)("em",{parentName:"p"},"status.prod")," fleet.)"),(0,s.kt)("p",null,"As a conclusion, the bottleneck is within the ",(0,s.kt)("em",{parentName:"p"},"Relay")," protocol itself and not the underlying databases. Or, in other words, both ",(0,s.kt)("em",{parentName:"p"},"SQLite")," and ",(0,s.kt)("em",{parentName:"p"},"Postgres")," can support the maximum insert rate a Waku node will operate within normal conditions."),(0,s.kt)("h3",{id:"query-test-results-jmeter"},"Query test results (jmeter)"),(0,s.kt)("p",null,"In this case, we are comparing ",(0,s.kt)("em",{parentName:"p"},"Store")," performance by means of Rest service."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Scenario")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"node",(0,s.kt)("em",{parentName:"li"},"a: one _nwaku")," node with ",(0,s.kt)("em",{parentName:"li"},"Store")," and connected to ",(0,s.kt)("em",{parentName:"li"},"Postgres.")),(0,s.kt)("li",{parentName:"ul"},"node",(0,s.kt)("em",{parentName:"li"},"b: one _nwaku")," node with ",(0,s.kt)("em",{parentName:"li"},"Store")," and using ",(0,s.kt)("em",{parentName:"li"},"SQLite"),"."),(0,s.kt)("li",{parentName:"ul"},"Both ",(0,s.kt)("em",{parentName:"li"},"Postgres")," and ",(0,s.kt)("em",{parentName:"li"},"SQLite")," contain +1 million rows."),(0,s.kt)("li",{parentName:"ul"},"node",(0,s.kt)("em",{parentName:"li"},"c: one _nwaku")," node with ",(0,s.kt)("em",{parentName:"li"},"REST")," enabled and acting as a ",(0,s.kt)("em",{parentName:"li"},"Store client")," for node_a."),(0,s.kt)("li",{parentName:"ul"},"node",(0,s.kt)("em",{parentName:"li"},"d: one _nwaku")," node with ",(0,s.kt)("em",{parentName:"li"},"REST")," enabled and acting as a ",(0,s.kt)("em",{parentName:"li"},"Store client")," for node_b."),(0,s.kt)("li",{parentName:"ul"},"With ",(0,s.kt)("em",{parentName:"li"},"jmeter"),", 10 users make ",(0,s.kt)("em",{parentName:"li"},"REST")," ",(0,s.kt)("em",{parentName:"li"},"Store")," requests concurrently to each of the \u201crest\u201d nodes (node_c and node_d.)"),(0,s.kt)("li",{parentName:"ul"},"All ",(0,s.kt)("em",{parentName:"li"},"nwaku")," nodes running statusteam/nim-waku:v0.19.0")),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://github.com/waku-org/test-waku-query/blob/master/docker/jmeter/http_store_requests.jmx"},"This")," is the ",(0,s.kt)("em",{parentName:"p"},"jmeter")," project used."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Using jmeter",src:a(45390).Z,width:"1178",height:"458"})),(0,s.kt)("p",null,(0,s.kt)("em",{parentName:"p"},"Results")),(0,s.kt)("p",null,"With this, the ",(0,s.kt)("em",{parentName:"p"},"node_b")," brings a higher throughput than the ",(0,s.kt)("em",{parentName:"p"},"node_a")," and that indicates that the node that uses SQLite performs better. The following shows the measures taken by ",(0,s.kt)("em",{parentName:"p"},"jmeter")," with regard to the REST requests."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"jmeter results",src:a(71101).Z,width:"1475",height:"73"})),(0,s.kt)("h3",{id:"query-test-results-only-store-protocol"},"Query test results (only Store protocol)"),(0,s.kt)("p",null,"In this test suite, only the Store protocol is being analyzed, i.e. without REST. For that, a go-waku node is used, which acts as ",(0,s.kt)("em",{parentName:"p"},"Store")," client. On the other hand, we have another go-waku app that publishes random ",(0,s.kt)("em",{parentName:"p"},"Relay")," messages periodically. Therefore, this can be considered a more realistic approach."),(0,s.kt)("p",null,"The following diagram shows the topology used:"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Topology",src:a(83008).Z,width:"1270",height:"740"})),(0,s.kt)("p",null,"For that, the next apps were used:"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("a",{parentName:"li",href:"https://github.com/alrevuelta/waku-publisher/tree/9fb206c14a17dd37d20a9120022e86475ce0503f"},"Waku-publisher.")," This app can publish Relay messages with different numbers of clients "),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("a",{parentName:"li",href:"https://github.com/Ivansete-status/waku-store-query-generator/tree/19e6455537b6d44199cf0c8558480af5c6788b0d"},"Waku-store-query-generator"),". This app is based on the Waku-publisher but in this case, it can spawn concurrent go-waku Store clients.")),(0,s.kt)("p",null,"That topology is defined in ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/waku-org/test-waku-query/blob/7090cd125e739306357575730d0e54665c279670/docker/docker-compose-manual-binaries.yml"},"this")," docker-compose file."),(0,s.kt)("p",null,"Notice that the two ",(0,s.kt)("inlineCode",{parentName:"p"},"nwaku")," nodes run the very same version, which is compiled locally."),(0,s.kt)("h4",{id:"comparing-archive-sqlite--postgres-performance-in-nwaku-b6dd6899"},"Comparing archive SQLite & Postgres performance in ",(0,s.kt)("a",{parentName:"h4",href:"https://github.com/waku-org/nwaku/tree/b6dd6899030ee628813dfd60ad1ad024345e7b41"},"nwaku-b6dd6899")),(0,s.kt)("p",null,"The next results were obtained by running the docker-compose-manual-binaries.yml from ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/waku-org/test-waku-query/tree/c07807597faa781ae6c8c32eefdf48ecac03a7ba"},"test-waku-query-c078075")," in the sandbox machine (metal-01.he-eu-hel1.wakudev.misc.status.im.)"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Scenario 1")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Store rate:")," 1 user generating 1 store-req/sec."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Relay rate:")," 1 user generating 10msg/sec, 10KB each."),(0,s.kt)("p",null,"In this case, we can see that the SQLite performance is better regarding the store requests."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Insert time distribution",src:a(73267).Z,width:"1820",height:"306"})),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Query time distribution",src:a(95078).Z,width:"1820",height:"306"})),(0,s.kt)("p",null,"The following graph shows how the ",(0,s.kt)("em",{parentName:"p"},"SQLite")," node has blocking periods whereas the ",(0,s.kt)("em",{parentName:"p"},"Postgres")," always gives a steady rate."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Num queries per minute",src:a(64427).Z,width:"1828",height:"240"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Scenario 2")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Store rate:")," 10 users generating 1 store-req/sec."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Relay rate:")," 1 user generating 10msg/sec, 10KB each."),(0,s.kt)("p",null,"In this case, is more evident that the ",(0,s.kt)("em",{parentName:"p"},"SQLite")," performs better."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Insert time distribution",src:a(29025).Z,width:"1829",height:"311"})),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Query time distribution",src:a(17139).Z,width:"1826",height:"533"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Scenario 3")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Store rate:")," 25 users generating 1 store-req/sec."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Relay rate:")," 1 user generating 10msg/sec, 10KB each."),(0,s.kt)("p",null,"In this case, the performance is similar regarding the timings. The store rate is bigger in ",(0,s.kt)("em",{parentName:"p"},"SQLite")," and ",(0,s.kt)("em",{parentName:"p"},"Postgres")," keeps the same level as in scenario 2."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Insert time distribution",src:a(22320).Z,width:"1826",height:"305"})),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Query time distribution",src:a(90968).Z,width:"1826",height:"535"})),(0,s.kt)("h4",{id:"comparing-archive-sqlite--postgres-performance-in-nwaku-b452ed8"},"Comparing archive SQLite & Postgres performance in ",(0,s.kt)("a",{parentName:"h4",href:"https://github.com/waku-org/nwaku/tree/b452ed865466a33b7f5b87fa937a8471b28e466e"},"nwaku-b452ed8")),(0,s.kt)("p",null,"This nwaku commit is after a few ",(0,s.kt)("strong",{parentName:"p"},"Postgres")," optimizations were applied."),(0,s.kt)("p",null,"The next results were obtained by running the docker-compose-manual-binaries.yml from ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/waku-org/test-waku-query/tree/c07807597faa781ae6c8c32eefdf48ecac03a7ba"},"test-waku-query-c078075")," in the sandbox machine (metal-01.he-eu-hel1.wakudev.misc.status.im.)"),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Scenario 1")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Store rate")," 1 user generating 1 store-req/sec. Notice that the current Store query used generates pagination which provokes more subsequent queries than the 1 req/sec that would be expected without pagination."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Relay rate:")," 1 user generating 10msg/sec, 10KB each."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Insert time distribution",src:a(94578).Z,width:"1831",height:"306"})),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Query time distribution",src:a(10835).Z,width:"1831",height:"533"})),(0,s.kt)("p",null,"It cannot be appreciated but the average ",(0,s.kt)("strong",{parentName:"p"},"*"),"Store",(0,s.kt)("strong",{parentName:"p"},"*")," time was 11ms."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Scenario 2")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Store rate:")," 10 users generating 1 store-req/sec. Notice that the current Store query used generates pagination which provokes more subsequent queries than the 10 req/sec that would be expected without pagination."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Relay rate:")," 1 user generating 10msg/sec, 10KB each."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Insert time distribution",src:a(2638).Z,width:"1832",height:"311"})),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Query time distribution",src:a(8732).Z,width:"1828",height:"537"})),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Scenario 3")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Store rate:")," 25 users generating 1 store-req/sec. Notice that the current Store query used generates pagination which provokes more subsequent queries than the 25 req/sec that would be expected without pagination. "),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Relay rate:")," 1 user generating 10msg/sec, 10KB each."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Insert time distribution",src:a(71328).Z,width:"1834",height:"311"})),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Query time distribution",src:a(92608).Z,width:"1828",height:"540"})),(0,s.kt)("h4",{id:"conclusions"},"Conclusions"),(0,s.kt)("p",null,"After comparing both systems, ",(0,s.kt)("em",{parentName:"p"},"SQLite")," performs much better than ",(0,s.kt)("em",{parentName:"p"},"Postgres")," However, a benefit of using ",(0,s.kt)("em",{parentName:"p"},"Postgres")," is that it performs asynchronous operations, and therefore doesn\u2019t consume CPU time that would be better invested in ",(0,s.kt)("em",{parentName:"p"},"Relay")," for example."),(0,s.kt)("p",null,"Remember that ",(0,s.kt)("em",{parentName:"p"},"nwaku")," is single-threaded and ",(0,s.kt)("em",{parentName:"p"},"chronos")," performs orchestration among a bunch of async tasks, and therefore it is not a good practice to block the whole ",(0,s.kt)("em",{parentName:"p"},"nwaku")," process in a query, as happens with ",(0,s.kt)("em",{parentName:"p"},"SQLite")),(0,s.kt)("p",null,"After applying a few ",(0,s.kt)("em",{parentName:"p"},"Postgres")," enhancements, it can be noticed that the use of concurrent ",(0,s.kt)("em",{parentName:"p"},"Store")," queries doesn\u2019t go below the 250ms barrier. The reason for that is that most of the time is being consumed in ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/waku-org/nwaku/blob/6da1aeec5370bb1c116509e770178cca2662b69c/waku/common/databases/db_postgres/dbconn.nim#L124"},"this point"),". The ",(0,s.kt)("inlineCode",{parentName:"p"},"libpqisBusy()")," function indicates that the connection is still busy even the queries finished."),(0,s.kt)("p",null,"Notice that we usually have a rate below 1100 req/minute in ",(0,s.kt)("em",{parentName:"p"},"status.prod")," fleet (checked November 7, 2023.)"),(0,s.kt)("hr",null),(0,s.kt)("h3",{id:"multiple-nodes--one-single-database"},"Multiple nodes & one single database"),(0,s.kt)("p",null,"This study aims to look for possible issues when having only one single database while several Waku nodes insert or retrieve data from it.\nThe following diagram shows the scenery used for such analysis."),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"digram_multiple_nodes_one_database",src:a(76148).Z,width:"1581",height:"867"})),(0,s.kt)("p",null,"There are three nim-waku nodes that are connected to the same database and all of them are trying to write messages to the same ",(0,s.kt)("em",{parentName:"p"},"PostgreSQL")," instance. With that, it is very common to see errors like:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},'ERR 2023-11-27 13:18:07.575+00:00 failed to insert message                   topics="waku archive" tid=2921 file=archive.nim:111 err="error in runStmt: error in dbConnQueryPrepared calling waitQueryToFinish: error in query: ERROR:  duplicate key value violates unique constraint \\"messageindex\\"\\nDETAIL:  Key (storedat, id, pubsubtopic)=(1701091087417938405, 479c95bbf74222417abf76c7f9c480a6790e454374dc4f59bbb15ca183ce1abd, /waku/2/default-waku/proto) already exists.\\n\n')),(0,s.kt)("p",null,"The ",(0,s.kt)("inlineCode",{parentName:"p"},"db-postgres-hammer")," is aimed to stress the database from the ",(0,s.kt)("inlineCode",{parentName:"p"},"select")," point of view. It performs ",(0,s.kt)("inlineCode",{parentName:"p"},"N")," concurrent ",(0,s.kt)("inlineCode",{parentName:"p"},"select")," queries with a certain rate."),(0,s.kt)("h4",{id:"results"},"Results"),(0,s.kt)("p",null,"The following results were obtained by using the sandbox machine (metal-01.he-eu-hel1.wakudev.misc) and running nim-waku nodes from ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/waku-org/nwaku/tree/b452ed865466a33b7f5b87fa937a8471b28e466e"},"https://github.com/waku-org/nwaku/tree/b452ed865466a33b7f5b87fa937a8471b28e466e")," and using the ",(0,s.kt)("inlineCode",{parentName:"p"},"test-waku-query")," project from ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/waku-org/test-waku-query/tree/fef29cea182cc744c7940abc6c96d38a68739356"},"https://github.com/waku-org/test-waku-query/tree/fef29cea182cc744c7940abc6c96d38a68739356")),(0,s.kt)("p",null,"The following shows the results"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"Two ",(0,s.kt)("inlineCode",{parentName:"li"},"nwaku-postgres-additional")," inserting messages plus 50 ",(0,s.kt)("inlineCode",{parentName:"li"},"db-postgres-hammer")," making 10 ",(0,s.kt)("inlineCode",{parentName:"li"},"selects")," per second.")),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Insert time distribution Postgres",src:a(49832).Z,width:"924",height:"288"})),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Query time distribution Postgres",src:a(82960).Z,width:"913",height:"307"})),(0,s.kt)("ol",{start:2},(0,s.kt)("li",{parentName:"ol"},"Five ",(0,s.kt)("inlineCode",{parentName:"li"},"nwaku-postgres-additional")," inserting messages plus 50 ",(0,s.kt)("inlineCode",{parentName:"li"},"db-postgres-hammer")," making 10 ",(0,s.kt)("inlineCode",{parentName:"li"},"selects")," per second.\n",(0,s.kt)("img",{alt:"Insert time distribution Postgres",src:a(62771).Z,width:"913",height:"307"}),(0,s.kt)("img",{alt:"Query time distribution Postgres",src:a(70419).Z,width:"913",height:"307"}))),(0,s.kt)("p",null,"In this case, the insert time gets more spread because the insert operations are shared amongst five more nodes. The ",(0,s.kt)("em",{parentName:"p"},"Store")," query time remains the same on average."),(0,s.kt)("ol",{start:3},(0,s.kt)("li",{parentName:"ol"},"Five ",(0,s.kt)("inlineCode",{parentName:"li"},"nwaku-postgres-additional")," inserting messages plus 100 ",(0,s.kt)("inlineCode",{parentName:"li"},"db-postgres-hammer")," making 10 ",(0,s.kt)("inlineCode",{parentName:"li"},"selects")," per second.\nThis case is similar to 2. but stressing more the database.\n",(0,s.kt)("img",{alt:"Insert time distribution Postgres",src:a(29936).Z,width:"917",height:"308"}),(0,s.kt)("img",{alt:"Query time distribution Postgres",src:a(64840).Z,width:"909",height:"313"}))))}c.isMDXComponent=!0},76148:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/digram_multiple_nodes_one_database-f503210c733fbeb8a572f9f6ccd81adf.png"},29025:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/insert-time-dist-2-46dc8832866df6316c3c4198f72f7933.png"},22320:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/insert-time-dist-3-b0fea4a8261185b481d49f9ced83e3e5.png"},94578:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/insert-time-dist-4-f6d6bb7844c5da6d8b32b7a0ca04e9dd.png"},2638:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/insert-time-dist-5-8a5fc95666e514142280e7b31332860a.png"},71328:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/insert-time-dist-6-c296f68fc41d94a05facc5aa08bfef14.png"},62771:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/insert-time-dist-postgres-2-78f1bb4fc86aba4604ceda390a37dc96.png"},29936:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/insert-time-dist-postgres-3-8c6c424e8e30dd9201539a6eba942857.png"},49832:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/insert-time-dist-postgres-938248325bab6bd74a1945193f88a95c.png"},73267:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/insert-time-dist-24602d6973d24be6b019dad1777bb987.png"},71101:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/jmeter-results-b7c1925776dc6b56d42d959250eefe05.png"},64427:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/num-queries-per-minute-6a54abcc873ba4ec4a30058499435bbd.png"},17139:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/query-time-dist-2-ca8dd4d4dd040e11639ec9902494d762.png"},90968:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/query-time-dist-3-5ecfd6bfc2de09c5453c4a5f6ea2ef5c.png"},10835:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/query-time-dist-4-03ae15c83b1b754a6716b8d25593e7be.png"},8732:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/query-time-dist-5-eae87929d2d1e5a8399131d2492664f3.png"},92608:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/query-time-dist-6-9328594b3f669f5d217a7e4e70a997d9.png"},70419:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/query-time-dist-postgres-2-347ba236b22fccce5efa56b29dae2021.png"},64840:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/query-time-dist-postgres-3-ff3612d13d631359595fbc395976a237.png"},82960:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/query-time-dist-postgres-63483fc4a94701ff82c19fc292d00f5c.png"},95078:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/query-time-dist-f40e2f9ea1b96e1288c924f5c600d948.png"},83008:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/topology-only-store-protocol-4c1704db48f330abda7f925618c485b4.png"},45390:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/using-jmeter-fb15a8f1842c5307ac9c375518cf14d0.png"}}]);