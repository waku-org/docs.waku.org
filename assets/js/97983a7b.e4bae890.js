"use strict";(self.webpackChunkwaku_guide=self.webpackChunkwaku_guide||[]).push([[1937],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>m});var n=a(67294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var l=n.createContext({}),d=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},p=function(e){var t=d(e.components);return n.createElement(l.Provider,{value:t},e.children)},u="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=d(a),c=i,m=u["".concat(l,".").concat(c)]||u[c]||h[c]||r;return a?n.createElement(m,o(o({ref:t},p),{},{components:a})):n.createElement(m,o({ref:t},p))}));function m(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,o=new Array(r);o[0]=c;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:i,o[1]=s;for(var d=2;d<r;d++)o[d]=a[d];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},56055:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var n=a(87462),i=(a(67294),a(3905));const r={title:"Capped Bandwidth in Waku"},o=void 0,s={unversionedId:"research/research-and-studies/capped-bandwidth",id:"research/research-and-studies/capped-bandwidth",title:"Capped Bandwidth in Waku",description:"This post explains i) why The Waku Network requires a capped bandwidth per shard and ii) how to achieve it by rate limiting with RLN v2.",source:"@site/docs/research/research-and-studies/capped-bandwidth.md",sourceDirName:"research/research-and-studies",slug:"/research/research-and-studies/capped-bandwidth",permalink:"/research/research-and-studies/capped-bandwidth",draft:!1,editUrl:"https://github.com/waku-org/docs.waku.org/tree/develop/docs/research/research-and-studies/capped-bandwidth.md",tags:[],version:"current",lastUpdatedAt:1708340432,formattedLastUpdatedAt:"19 Feb 2024",frontMatter:{title:"Capped Bandwidth in Waku"},sidebar:"research",previous:{title:"PostgreSQL",permalink:"/research/benchmarks/postgres-adoption"},next:{title:"Incentivisation",permalink:"/research/research-and-studies/incentivisation"}},l={},d=[{value:"Problem",id:"problem",level:2},{value:"Previous Work",id:"previous-work",level:2},{value:"Current Solution (RLN v2)",id:"current-solution-rln-v2",level:2}],p={toc:d},u="wrapper";function h(e){let{components:t,...a}=e;return(0,i.kt)(u,(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"This post explains i) why The Waku Network requires a capped bandwidth per shard and ii) how to achieve it by rate limiting with RLN v2."),(0,i.kt)("h2",{id:"problem"},"Problem"),(0,i.kt)("p",null,'First of all, let\'s begin with the terminology. We have talked in the past about "predictable" bandwidth, but a better name would be "capped" bandwidth. This is because it is totally fine that the waku traffic is not predictable, as long as it is capped. And it has to be capped because otherwise, no one will be able to run a node.'),(0,i.kt)("p",null,"Since we aim that everyone can run a full waku node (at least subscribed to a single shard) it is of paramount importance that the bandwidth requirements (up/down) are i) reasonable to run with a residential internet connection in every country and ii) limited to an upper value, aka capped. If the required bandwidth to stay up to date with a topic is higher than what the node has available, then it will start losing messages and won't be able to stay up to date with the topic messages. And not to mention the problems this will cause to other services and applications being used by the user."),(0,i.kt)("p",null,"The main problem is that one can't just choose the bandwidth it allocates to ",(0,i.kt)("inlineCode",{parentName:"p"},"relay"),". One could set the maximum bandwidth willing to allocate to ",(0,i.kt)("inlineCode",{parentName:"p"},"store")," but this is not how ",(0,i.kt)("inlineCode",{parentName:"p"},"relay")," works. The required bandwidth is not set by the node, but by the network. If a pubsub topic ",(0,i.kt)("inlineCode",{parentName:"p"},"a"),' has a traffic of 50 Mbps (which is the sum of all messages being sent multiplied by its size, times the D_out degree), then if a node wants to stay up to date in that topic, and relay traffic in it, then it will require 50 Mbps. There is no thing such as "partially contributing" to the topic (with eg 25Mbps) because then you will be losing messages, becoming an unreliable peer and potentially be disconnected. The network sets the pace.'),(0,i.kt)("p",null,"So waku needs an upper boundary on the in/out bandwidth (mbps) it consumes. Just like apps have requirements on cpu and memory, we should set a requirement on bandwidth, and then guarantee that if you have that bandwidth, you will be able to run a node without any problem. And this is the tricky part. This metric is Waku's constraint, similar to the gas-per-block limit in blockchains."),(0,i.kt)("h2",{id:"previous-work"},"Previous Work"),(0,i.kt)("p",null,"Quick summary of the evolution to solve this problem:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Waku started with no rate-limiting mechanism. The network was subject to DoS attacks."),(0,i.kt)("li",{parentName:"ul"},"RLN v1 was introduced, which allowed to rate-limit in a privacy-preserving and anonymous way. The rate limit can be configured to 1 message every ",(0,i.kt)("inlineCode",{parentName:"li"},"y")," seconds. However, this didn't offer much granularity. A low ",(0,i.kt)("inlineCode",{parentName:"li"},"y")," would allow too many messages and a high ",(0,i.kt)("inlineCode",{parentName:"li"},"y")," would make the protocol unusable (impossible to send two messages in a row)."),(0,i.kt)("li",{parentName:"ul"},"RLN v2 was introduced, which allows to rate-limit each user to ",(0,i.kt)("inlineCode",{parentName:"li"},"x")," messages every ",(0,i.kt)("inlineCode",{parentName:"li"},"y")," seconds. This offers the granularity we need. It is the current solution deployed in The Waku Network.")),(0,i.kt)("h2",{id:"current-solution-rln-v2"},"Current Solution (RLN v2)"),(0,i.kt)("p",null,"The current solution to this problem is the usage of RLN v2, which allows to rate-limit ",(0,i.kt)("inlineCode",{parentName:"p"},"x")," messages every ",(0,i.kt)("inlineCode",{parentName:"p"},"y")," seconds. On top of this, the introduction of ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/waku-org/specs/blob/master/standards/core/rln-contract.md"},"WAKU2-RLN-CONTRACT")," enforces a maximum amount of messages that can be sent to the network per ",(0,i.kt)("inlineCode",{parentName:"p"},"epoch"),". This is achieved by limiting the amount of memberships that can be registered. The current values are:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"R_{max}"),": 160000 mgs/epoch"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"r_{max}"),": 600 msgs/epoch"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"r_{min}"),": 20 msgs/epoch")),(0,i.kt)("p",null,"In other words, the contract limits the amount of memberships that can be registered from ",(0,i.kt)("inlineCode",{parentName:"p"},"266")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"8000")," depending on which rate limit users choose."),(0,i.kt)("p",null,"On the other hand ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/vacp2p/rfc-index/blob/main/waku/standards/core/64/network.md"},"64/WAKU2-NETWORK")," states that:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rlnEpochSizeSec"),": 600. Meaning the epoch size is 600 seconds."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"maxMessageSize"),": 150KB. Meaning the maximum message size that is allowed. Note: recommended average of 4KB.")),(0,i.kt)("p",null,"Putting this all together and assuming:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Messages are sent uniformly distributed."),(0,i.kt)("li",{parentName:"ul"},"All users totally consumes its rate-limit.")),(0,i.kt)("p",null,"We can expect the following message rate and bandwidth for the whole network:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"A traffic of ",(0,i.kt)("inlineCode",{parentName:"li"},"266 msg/second")," on average (",(0,i.kt)("inlineCode",{parentName:"li"},"160000/600"),")"),(0,i.kt)("li",{parentName:"ul"},"A traffic of ",(0,i.kt)("inlineCode",{parentName:"li"},"6 MBps")," on average (266 ",(0,i.kt)("em",{parentName:"li"}," 4KB ")," 6), where ",(0,i.kt)("inlineCode",{parentName:"li"},"4KB")," is the average message size and ",(0,i.kt)("inlineCode",{parentName:"li"},"6")," is the average gossipsub D-out degree.")),(0,i.kt)("p",null,"And assuming a uniform distribution of traffic among 8 shards:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"33 msg/second")," per shard."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"0.75 MBps")," per shard.")))}h.isMDXComponent=!0}}]);